---
- hosts: all
  pre_tasks:
    - name: ensure packages are installed
      package:
        name: "{{ item }}"
      with_items:
        - openssl
        - php
        - php-fpm
        - php-gd
        - php-imap
        - php-intl
        - php-mbstring
        - php-mysqlnd
        - php-pdo
        - php-process
        - php-xml
        - php-zip
        - php-pecl-apcu
        - php-pecl-imagick
        - nginx
        - mariadb
        - mariadb-server
    - name: ensure path env variable for php-fpm is set
      lineinfile:
        dest: /etc/php-fpm.d/www.conf
        regexp: "^;?env\\[PATH\\] ="
        line: "env[PATH] = /usr/local/bin:/usr/bin:/bin"
    - name: ensure services are running
      service:
        name: "{{ item }}"
        enabled: yes
        state: started
      with_items:
        - php-fpm
        - nginx
        - mariadb
    - name: ensure dummy certificate exists
      command: /etc/pki/tls/certs/make-dummy-cert /etc/pki/tls/certs/example.com.crt
      args:
        creates: /etc/pki/tls/certs/example.com.crt
    - name: ensure php timezone is set
      copy:
        dest: /etc/php.d/90-custom.conf
        content: "date.timezone = UTC"
  roles:
    - vagrant
  vars:
    owncloud_ssl_certificate_key: "/etc/pki/tls/certs/example.com.crt"
    owncloud_config_defaultapp: "gallery,files"
    owncloud_config_trusted_domains: ["localhost", "example.com"]
    owncloud_restore_database: /vagrant/backup.sql
    owncloud_apps:
      - name: files_external
